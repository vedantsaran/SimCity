<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Full-Feature Baseball Simulator</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- React Router -->
  <script src="https://cdn.jsdelivr.net/npm/react-router-dom@6/umd/react-router-dom.development.js"></script>
  <!-- Recharts -->
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div id="root" class="h-screen flex flex-col"></div>

  <script type="text/babel">
  const { useState, useEffect } = React;
  const { BrowserRouter, Routes, Route, Link, useNavigate } = ReactRouterDOM;
  const { LineChart, Line, XAxis, YAxis, Tooltip, CartesianGrid, ResponsiveContainer } = Recharts;

  // --- Utility Models & Engine ---
  class Player {
    constructor(id, name) {
      this.id = id;
      this.name = name;
      this.batting = { contact: 50, power: 50, patience: 50 };
      this.pitching = { control: 50, velocity: 50, movement: 50 };
      this.fielding = { range: 50, arm: 50 };
    }
  }

  class Team {
    constructor(id, name) {
      this.id = id;
      this.name = name;
      this.roster = Array.from({length:9}, (_, i) => new Player(`${id}-${i}`, `Player ${i+1}`));
      this.stats = {}; // season stats
    }
  }

  // probabilities utility
  function weightedProb(weights) {
    let sum = Object.values(weights).reduce((a,b)=>a+b,0);
    let r = Math.random()*sum, acc=0;
    for(const [k,v] of Object.entries(weights)){
      acc+=v;
      if(r<=acc) return k;
    }
  }

  // simulate one at-bat
  function simulateAtBat(batter, pitcher, factors) {
    // simple logistic for outcome
    const b = (batter.batting.contact + batter.batting.power*0.7)*factors.offense;
    const p = (pitcher.pitching.control + pitcher.pitching.movement)*factors.defense;
    const total = b + p;
    const hitW = b/total;
    const walkW = batter.batting.patience/200;
    const strikeoutW = p/total;
    const weights = { H: hitW, BB: walkW, K: strikeoutW, O: 1-(hitW+walkW+strikeoutW) };
    return weightedProb(weights);
  }

  // simulate one game
  function simulateGame(home, away, settings) {
    const log = [], box = { [home.id]:{R:0,H:0,BB:0,K:0}, [away.id]:{R:0,H:0,BB:0,K:0} };
    for(let inning=1; inning<=9; inning++){
      for(const team of [away, home]) {
        let outs=0, runs=0, bases=[false,false,false];
        while(outs<3) {
          const batter = team.roster[(inning+outs)%9];
          const pitcher = (team===home?away:home).roster[0]; // starter is index 0
          const o=simulateAtBat(batter,pitcher,settings);
          if(o==='H'){
            // single only
            bases[2] && (runs++, box[team.id].R++);
            bases[1] && (bases[2]=true, bases[1]=false);
            bases[0] && (bases[1]=true, bases[0]=false);
            bases[0]=true; box[team.id].H++;
            log.push(`${inning}${team===home?'H':'A'}: ${batter.name} hit a single. +${runs} run(s).`);
          } else if(o==='BB'){
            box[team.id].BB++; log.push(`${inning}${team===home?'H':'A'}: ${batter.name} walked.`);
            // advance forced
            if(bases.every(x=>x)) { runs++; box[team.id].R++; log.push(`  run scored.`);
            } else { for(let i=2;i>=0;i--) if(bases[i]&&bases[i+1]===false) bases[i]=false, bases[i+1]=true; }
          } else if(o==='K'){
            outs++; box[team.id].K++; log.push(`${inning}${team===home?'H':'A'}: ${batter.name} struck out.`);
          } else {
            outs++; log.push(`${inning}${team===home?'H':'A'}: ${batter.name} made an out.`); 
          }
        }
      }
    }
    return { log, box };
  }

  // simulate a season
  function simulateSeason(teams, settings) {
    teams.forEach(t=>t.stats={W:0,L:0,RS:0,RA:0});
    for(let i=0;i<teams.length;i++){
      for(let j=i+1;j<teams.length;j++){
        const g1=simulateGame(teams[i],teams[j],settings);
        const r1=g1.box[teams[i].id].R, r2=g1.box[teams[j].id].R;
        if(r1>r2) teams[i].stats.W++, teams[j].stats.L++;
        else teams[j].stats.W++, teams[i].stats.L++;
        teams[i].stats.RS+=r1; teams[i].stats.RA+=r2;
        teams[j].stats.RS+=r2; teams[j].stats.RA+=r1;
      }
    }
    return teams;
  }

  // compute advanced metrics
  function computeDerived(team) {
    const {W, L, RS, RA} = team.stats;
    const Pyth = Math.pow(RS,2)/ (Math.pow(RS,2)+Math.pow(RA,2));
    return {...team.stats, Pyth};
  }

  // persistence
  function loadLeague(){return JSON.parse(localStorage.getItem('league')||'null');}
  function saveLeague(data){localStorage.setItem('league', JSON.stringify(data));}

  // --- React Components ---

  function Nav(){ return (
    <nav className="bg-white shadow px-4 py-2 flex space-x-4">
      {['Simulator','Roster','Stats','Settings'].map(p=>
        <Link key={p} to={`/${p.toLowerCase()}`} className="text-blue-600 hover:underline">{p}</Link>
      )}
    </nav>
  );}

  function Simulator({teams, settings, setResults}) {
    const [gameLog, setGameLog] = useState([]);
    const [box, setBox] = useState({});
    const runGame=()=>{
      const {log,box}=simulateGame(teams[1],teams[0],settings);
      setGameLog(log); setBox(box);
    };
    const runSeason=()=>{
      const res=simulateSeason([...teams], settings).map(computeDerived);
      setResults(res);
    };
    return (
      <div className="p-4 flex gap-4">
        <div className="flex-shrink-0 space-y-2">
          <button onClick={runGame} className="btn">Simulate Game</button>
          <button onClick={runSeason} className="btn">Simulate Season</button>
          <pre className="bg-white p-2 h-64 overflow-y-auto">{gameLog.join('\n')}</pre>
        </div>
        <div className="grow">
          <h3 className="font-bold">Box Score</h3>
          <table className="table-auto w-full bg-white">
            <thead><tr><th>Team</th><th>R</th><th>H</th><th>BB</th><th>K</th></tr></thead>
            <tbody>
              {teams.map(t=>(
                <tr key={t.id}>
                  <td>{t.name}</td>
                  <td>{box[t.id]?.R||0}</td>
                  <td>{box[t.id]?.H||0}</td>
                  <td>{box[t.id]?.BB||0}</td>
                  <td>{box[t.id]?.K||0}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  }

  function RosterEditor({teams,setTeams}) {
    const updateAttr=(teamIdx,playerIdx,attr,stat,e)=> {
      const v=Math.max(0,Math.min(100,parseInt(e.target.value)||0));
      const t=[...teams]; t[teamIdx].roster[playerIdx][attr][stat]=v;
      setTeams(t); saveLeague({teams,settings:loadLeague()?.settings});
    };
    return (
      <div className="p-4 grid grid-cols-2 gap-4">
        {teams.map((team,ti)=>(
          <div key={team.id} className="bg-white p-3 rounded shadow">
            <h3 className="font-bold text-lg mb-2">{team.name}</h3>
            {team.roster.map((p,pi)=>(
              <div key={p.id} className="mb-2 border-b pb-2">
                <div className="font-semibold">{p.name}</div>
                <div className="flex space-x-2 text-sm">
                  {['contact','power','patience'].map(stat=>(
                    <label key={stat} className="flex items-center space-x-1">
                      <span>{stat.charAt(0).toUpperCase()}</span>
                      <input type="number" value={p.batting[stat]}
                        onChange={e=>updateAttr(ti,pi,'batting',stat,e)}
                        className="w-12 p-1 border rounded text-right"/>
                    </label>
                  ))}
                </div>
              </div>
            ))}
          </div>
        ))}
      </div>
    );
  }

  function Stats({results}) {
    const data = results.map(t=>({ name:t.name, ...t }));
    return (
      <div className="p-4">
        <h3 className="font-bold mb-2">Standings & Pythagorean Win %</h3>
        <table className="table-auto bg-white mb-4">
          <thead><tr><th>Team</th><th>W</th><th>L</th><th>Pyth%</th></tr></thead>
          <tbody>
            {data.sort((a,b)=>b.W-a.W).map(t=>(
              <tr key={t.name}>
                <td>{t.name}</td>
                <td>{t.W}</td>
                <td>{t.L}</td>
                <td>{(t.Pyth*100).toFixed(1)}%</td>
              </tr>
            ))}
          </tbody>
        </table>
        <h3 className="font-bold mb-2">Runs Scored vs Allowed</h3>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={data}>
            <XAxis dataKey="name"/> <YAxis/> <Tooltip/> <CartesianGrid strokeDasharray="3 3"/>
            <Line type="monotone" dataKey="RS" name="Runs Scored"/> 
            <Line type="monotone" dataKey="RA" stroke="#ff7300" name="Runs Allowed"/>
          </LineChart>
        </ResponsiveContainer>
      </div>
    );
  }

  function Settings({settings,setSettings}) {
    const change=(k,v)=>{const s={...settings,[k]:v}; setSettings(s); saveLeague({teams:loadLeague()?.teams,settings:s});};
    return (
      <div className="p-4 space-y-4 max-w-sm">
        <label className="block">
          Ballpark Offense Factor: {settings.offense.toFixed(2)}
          <input type="range" min="0.5" max="1.5" step="0.01" value={settings.offense}
            onChange={e=>change('offense',+e.target.value)} className="w-full"/>
        </label>
        <label className="block">
          Ballpark Defense Factor: {settings.defense.toFixed(2)}
          <input type="range" min="0.5" max="1.5" step="0.01" value={settings.defense}
            onChange={e=>change('defense',+e.target.value)} className="w-full"/>
        </label>
      </div>
    );
  }

  function App(){
    const saved = loadLeague();
    const [teams,setTeams] = useState(saved?.teams || [new Team('T1','Home'), new Team('T2','Away')]);
    const [settings,setSettings] = useState(saved?.settings || {offense:1, defense:1});
    const [results,setResults] = useState([]);

    useEffect(()=> saveLeague({teams,settings}),[teams,settings]);

    return (
      <BrowserRouter>
        <Nav/>
        <Routes>
          <Route path="/" element={<Simulator teams={teams} settings={settings} setResults={setResults}/>}/>
          <Route path="/simulator" element={<Simulator teams={teams} settings={settings} setResults={setResults}/>}/>
          <Route path="/roster" element={<RosterEditor teams={teams} setTeams={setTeams}/>}/>
          <Route path="/stats" element={<Stats results={results}/>}/>
          <Route path="/settings" element={<Settings settings={settings} setSettings={setSettings}/>}/>
        </Routes>
      </BrowserRouter>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
  <style>
    .btn { @apply bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700; }
    table { @apply w-full border-collapse; }
    th, td { @apply border px-2 py-1; }
  </style>
</body>
</html>
