<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>In-Depth City Simulation</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #e0e0e0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    /* Sidebar */
    #sidebar {
      width: 280px;
      background-color: #2f2f2f;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 1.3em;
      border-bottom: 2px solid #ffcc00;
      padding-bottom: 5px;
    }
    .stat {
      margin: 8px 0;
    }
    .buttons {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
    }
    .buttons button {
      flex: 1 1 120px;
      margin: 5px;
      padding: 10px;
      border: none;
      background-color: #ffcc00;
      color: #2f2f2f;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .buttons button:hover {
      background-color: #e6b800;
    }
    /* Main Simulation Area */
    #main {
      flex: 1;
      position: relative;
      background-color: #87ceeb;
      overflow: hidden;
    }
    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(40, 1fr);
      grid-template-rows: repeat(30, 1fr);
    }
    .tile {
      border: 1px solid #aaa;
      box-sizing: border-box;
      cursor: pointer;
    }
    /* Terrain Types */
    .tile.grass { background-color: #7cfc00; }
    .tile.water { background-color: #1e90ff; }
    .tile.road { background-color: #555; }
    .tile.residential { background-color: #ffebcd; }
    .tile.commercial { background-color: #ffe4e1; }
    .tile.industrial { background-color: #d3d3d3; }
    /* Overlay */
    #overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 4px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>City Dashboard</h2>
    <div class="stat">Day: <span id="dayDisplay">1</span> / 365</div>
    <div class="stat">Population: <span id="populationDisplay">0</span></div>
    <div class="stat">Money: $<span id="moneyDisplay">10000</span></div>
    <div class="stat">Happiness: <span id="happinessDisplay">50</span>%</div>
    <div class="stat">Tax Rate: <span id="taxRateDisplay">10</span>%</div>
    <div class="stat">Electricity Coverage: <span id="powerDisplay">0</span>%</div>
    <div class="stat">Water Coverage: <span id="waterDisplay">0</span>%</div>
    <div class="stat">Employment Rate: <span id="employmentDisplay">0</span>%</div>
    <h2>Build Options</h2>
    <div class="buttons">
      <button data-type="road">Road</button>
      <button data-type="residential">Residential ($100/lot)</button>
      <button data-type="commercial">Commercial ($300/lot)</button>
      <button data-type="industrial">Industrial ($250/lot)</button>
      <button data-type="powerPlant">Power Plant ($5000)</button>
      <button data-type="waterPlant">Water Plant ($4000)</button>
    </div>
    <h2>Settings</h2>
    <label for="taxRateInput">Tax Rate (%):</label>
    <input type="number" id="taxRateInput" min="0" max="50" step="1" value="10" />
    <button id="applyTaxBtn" style="margin-top:10px;">Apply Tax Rate</button>
  </div>

  <div id="main">
    <div id="map"></div>
    <div id="overlay">Hover over a tile for info</div>
  </div>

  <script>
    // Simulation Constants
    const ROWS = 30;
    const COLS = 40;
    const TILE_SIZE = 20;
    const INITIAL_FUNDS = 10000;
    const MAX_DAYS = 365;
    const POPULATION_PER_RESIDENTIAL = 5;
    const EMPLOYMENT_PER_COMMERCIAL = 10;
    const EMPLOYMENT_PER_INDUSTRIAL = 15;
    const POWER_COST_PER_RESIDENT = 1;
    const WATER_COST_PER_RESIDENT = 1;
    const TAX_COLLECTION_INTERVAL = 7; // days

    // State Variables
    let day = 1;
    let money = INITIAL_FUNDS;
    let population = 0;
    let happiness = 50;
    let taxRate = 0.10;
    let powerCoverage = 0;
    let waterCoverage = 0;
    let employmentRate = 0;

    // Map grid: each tile stores type and any building data
    const mapGrid = [];

    // References to DOM
    const dayDisplay = document.getElementById('dayDisplay');
    const moneyDisplay = document.getElementById('moneyDisplay');
    const populationDisplay = document.getElementById('populationDisplay');
    const happinessDisplay = document.getElementById('happinessDisplay');
    const taxRateDisplay = document.getElementById('taxRateDisplay');
    const powerDisplay = document.getElementById('powerDisplay');
    const waterDisplay = document.getElementById('waterDisplay');
    const employmentDisplay = document.getElementById('employmentDisplay');
    const taxRateInput = document.getElementById('taxRateInput');
    const applyTaxBtn = document.getElementById('applyTaxBtn');
    const mapElement = document.getElementById('map');
    const overlay = document.getElementById('overlay');

    const buildButtons = document.querySelectorAll('#sidebar .buttons button');
    let selectedBuild = null;

    // Initialize Grid
    function initGrid() {
      mapElement.style.gridTemplateColumns = `repeat(${COLS}, ${TILE_SIZE}px)`;
      mapElement.style.gridTemplateRows = `repeat(${ROWS}, ${TILE_SIZE}px)`;
      for (let r = 0; r < ROWS; r++) {
        const row = [];
        for (let c = 0; c < COLS; c++) {
          const tile = document.createElement('div');
          tile.classList.add('tile', 'grass');
          tile.style.width = TILE_SIZE + 'px';
          tile.style.height = TILE_SIZE + 'px';
          tile.dataset.row = r;
          tile.dataset.col = c;
          tile.dataset.type = 'grass';
          tile.addEventListener('click', onTileClick);
          tile.addEventListener('mouseover', onTileHover);
          tile.addEventListener('mouseout', () => overlay.textContent = 'Hover over a tile for info');
          mapElement.appendChild(tile);
          row.push({ type: 'grass', building: null, dom: tile });
        }
        mapGrid.push(row);
      }
    }

    // Update Dashboard Stats
    function updateStats() {
      dayDisplay.textContent = day;
      moneyDisplay.textContent = money.toFixed(2);
      populationDisplay.textContent = population;
      happinessDisplay.textContent = happiness;
      taxRateDisplay.textContent = Math.round(taxRate * 100);
      powerDisplay.textContent = Math.round(powerCoverage * 100);
      waterDisplay.textContent = Math.round(waterCoverage * 100);
      employmentDisplay.textContent = Math.round(employmentRate * 100);
    }

    // Build Button Handlers
    buildButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedBuild = btn.dataset.type;
        buildButtons.forEach(b => b.style.border = 'none');
        btn.style.border = '2px solid #ffcc00';
      });
    });

    // Apply Tax Rate
    applyTaxBtn.addEventListener('click', () => {
      const value = parseInt(taxRateInput.value, 10);
      if (!isNaN(value) && value >= 0 && value <= 50) {
        taxRate = value / 100;
        updateStats();
      }
    });

    // Tile Click: Try to build selected structure
    function onTileClick(e) {
      if (!selectedBuild) return;
      const r = parseInt(e.target.dataset.row, 10);
      const c = parseInt(e.target.dataset.col, 10);
      const cell = mapGrid[r][c];
      if (cell.type !== 'grass') return; // Only build on grass
      switch (selectedBuild) {
        case 'road':
          buildRoad(cell);
          break;
        case 'residential':
          buildResidential(cell);
          break;
        case 'commercial':
          buildCommercial(cell);
          break;
        case 'industrial':
          buildIndustrial(cell);
          break;
        case 'powerPlant':
          buildPowerPlant(cell);
          break;
        case 'waterPlant':
          buildWaterPlant(cell);
          break;
      }
      updateStats();
    }

    // Tile Hover: Show info
    function onTileHover(e) {
      const r = parseInt(e.target.dataset.row, 10);
      const c = parseInt(e.target.dataset.col, 10);
      const cell = mapGrid[r][c];
      let info = `Tile [${r}, ${c}] - ${cell.type}`;
      if (cell.building) {
        info += ` (${cell.building.type})`;
      }
      overlay.textContent = info;
    }

    // Build Functions
    function buildRoad(cell) {
      if (money < 50) return alert('Not enough funds for road ($50).');
      money -= 50;
      cell.type = 'road';
      cell.dom.className = 'tile road';
    }
    function buildResidential(cell) {
      if (money < 100) return alert('Not enough funds for residential lot ($100).');
      money -= 100;
      cell.type = 'residential';
      cell.building = { type: 'residential', occupants: POPULATION_PER_RESIDENTIAL };
      cell.dom.className = 'tile residential';
    }
    function buildCommercial(cell) {
      if (money < 300) return alert('Not enough funds for commercial lot ($300).');
      money -= 300;
      cell.type = 'commercial';
      cell.building = { type: 'commercial', jobs: EMPLOYMENT_PER_COMMERCIAL };
      cell.dom.className = 'tile commercial';
    }
    function buildIndustrial(cell) {
      if (money < 250) return alert('Not enough funds for industrial lot ($250).');
      money -= 250;
      cell.type = 'industrial';
      cell.building = { type: 'industrial', jobs: EMPLOYMENT_PER_INDUSTRIAL };
      cell.dom.className = 'tile industrial';
    }
    function buildPowerPlant(cell) {
      if (money < 5000) return alert('Not enough funds for power plant ($5000).');
      money -= 5000;
      cell.type = 'powerPlant';
      cell.building = { type: 'powerPlant', capacity: 1000 };
      cell.dom.className = 'tile';
      cell.dom.style.backgroundColor = '#ffa500'; // Orange for power plant
    }
    function buildWaterPlant(cell) {
      if (money < 4000) return alert('Not enough funds for water plant ($4000).');
      money -= 4000;
      cell.type = 'waterPlant';
      cell.building = { type: 'waterPlant', capacity: 1000 };
      cell.dom.className = 'tile';
      cell.dom.style.backgroundColor = '#00ced1'; // Teal for water plant
    }

    // Simulation Tick (Daily)
    function simulateDay() {
      // Reset daily accumulators
      let newPopulation = 0;
      let jobs = 0;
      let powerProduction = 0;
      let waterProduction = 0;

      // Scan grid for metrics
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const cell = mapGrid[r][c];
          if (cell.building) {
            switch (cell.building.type) {
              case 'residential':
                newPopulation += cell.building.occupants;
                break;
              case 'commercial':
                jobs += cell.building.jobs;
                break;
              case 'industrial':
                jobs += cell.building.jobs;
                break;
              case 'powerPlant':
                powerProduction += cell.building.capacity;
                break;
              case 'waterPlant':
                waterProduction += cell.building.capacity;
                break;
            }
          }
        }
      }

      population = newPopulation;
      const employed = Math.min(jobs, population);
      employmentRate = population ? (employed / population) : 0;

      // Coverage: simple ratio of production to need
      const requiredPower = population * POWER_COST_PER_RESIDENT;
      const requiredWater = population * WATER_COST_PER_RESIDENT;

      powerCoverage = requiredPower ? Math.min(powerProduction / requiredPower, 1) : 0;
      waterCoverage = requiredWater ? Math.min(waterProduction / requiredWater, 1) : 0;

      // Happiness modifiers
      happiness = 50;
      if (powerCoverage < 1) happiness -= (1 - powerCoverage) * 50;
      if (waterCoverage < 1) happiness -= (1 - waterCoverage) * 50;
      if (employmentRate < 1) happiness -= (1 - employmentRate) * 50;
      happiness = Math.max(0, Math.min(100, happiness));

      // Tax revenue weekly
      if (day % TAX_COLLECTION_INTERVAL === 0) {
        const taxRevenue = population * taxRate * 10; // $10 per citizen baseline
        money += taxRevenue;
      }

      updateStats();
      day++;
      if (day > MAX_DAYS) {
        clearInterval(simulationInterval);
        alert(`Simulation complete! Final funds: $${money.toFixed(2)}`);
      }
    }

    // Start Simulation Loop
    initGrid();
    updateStats();
    const simulationInterval = setInterval(simulateDay, 2000); // each day = 2s
  </script>
</body>
</html>
